<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Dashami Silk</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Berkshire+Swash&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #800000;
            --primary-light: #a33333;
            --bg-color: #f8f5f2;
            --card-bg: #ffffff;
            --text-main: #2c2c2c;
            --text-muted: #888;
            --accent-gold: #c5a059;
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Poppins', sans-serif;
            padding-top: 100px;
            color: var(--text-main);
        }

        /* --- HEADER --- */
        #floating-header {
            background: rgba(128, 0, 0, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 20px rgba(128, 0, 0, 0.2);
        }
        .brand-font { font-family: 'Berkshire Swash', cursive; }

        /* --- CARDS & LAYOUT --- */
        .glass-card {
            background: var(--card-bg);
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.04);
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        .section-header {
            background: linear-gradient(to right, #fff0e6, #fff);
            padding: 15px 25px;
            border-left: 5px solid var(--primary);
            font-weight: 600;
            color: var(--primary);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        /* --- UPLOAD ZONES --- */
        .upload-zone {
            border: 2px dashed #e0e0e0;
            border-radius: 15px;
            background: #fafafa;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .upload-zone:hover {
            border-color: var(--primary);
            background: #fff5f5;
            transform: translateY(-2px);
        }
        .upload-icon {
            font-size: 2.5rem;
            color: #ddd;
            margin-bottom: 10px;
            transition: color 0.3s;
        }
        .upload-zone:hover .upload-icon { color: var(--primary); }
        .upload-text { font-size: 0.8rem; font-weight: 600; color: #666; }

        /* --- PREVIEWS --- */
        .media-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .media-item {
            aspect-ratio: 1; border-radius: 10px; overflow: hidden;
            position: relative; background: #000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 1px solid #eee;
        }
        .media-item img { width: 100%; height: 100%; object-fit: contain; background: #fff; }
        .btn-rotate {
            position: absolute; bottom: 5px; right: 5px;
            background: rgba(128, 0, 0, 0.8); color: white;
            border: none; border-radius: 50%; width: 25px; height: 25px;
            font-size: 0.7rem; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(2px); transition: 0.2s;
        }
        .btn-rotate:hover { background: #fff; color: var(--primary); }

        /* --- FORM INPUTS --- */
        .form-floating > .form-control, .form-floating > .form-select {
            border: 1px solid #eee;
            border-radius: 12px;
            background: #fdfdfd;
        }
        .form-floating > .form-control:focus, .form-floating > .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(128, 0, 0, 0.1);
        }
        .form-floating > label { color: #999; font-size: 0.9rem; }

        /* --- STOCK SWITCH --- */
        .stock-switch {
            display: flex; background: #eee; border-radius: 30px; padding: 4px;
            position: relative; cursor: pointer; user-select: none;
        }
        .stock-option {
            flex: 1; text-align: center; padding: 8px; z-index: 2;
            font-size: 0.8rem; font-weight: 700; transition: color 0.3s;
            border-radius: 25px;
        }
        .stock-option.active { color: white; background: var(--primary); box-shadow: 0 2px 10px rgba(128,0,0,0.3); }

        /* --- ACTION BUTTON --- */
        .btn-save {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border: none; color: white; font-weight: 600;
            border-radius: 50px; padding: 15px;
            letter-spacing: 1px; box-shadow: 0 10px 20px rgba(128, 0, 0, 0.2);
            transition: all 0.3s;
        }
        .btn-save:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(128, 0, 0, 0.3);
        }
        .btn-save:disabled { background: #ccc; transform: none; box-shadow: none; }

        /* --- STATUS --- */
        .status-badge {
            background: rgba(255,255,255,0.1);
            padding: 5px 15px; border-radius: 20px;
            font-size: 0.75rem; border: 1px solid rgba(255,255,255,0.2);
        }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .online { background-color: #4ade80; box-shadow: 0 0 8px #4ade80; }
        .offline { background-color: #f87171; }

    </style>
</head>
<body>

<header id="floating-header" class="fixed-top">
    <div class="container-fluid px-4 py-3">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <img src="logo/logo.png" class="rounded-circle border border-2 border-white" width="45" height="45">
                <div>
                    <h5 class="m-0 text-white brand-font" style="letter-spacing: 0.5px;">Dashami Admin</h5>
                    <div class="status-badge text-white">
                        <span id="statusDot" class="status-dot offline"></span> <span id="statusText">CONNECTING...</span>
                    </div>
                </div>
            </div>
            <a href="main.html" class="btn btn-light btn-sm rounded-pill px-4 fw-bold" style="color: var(--primary);">
                View Shop <i class="fa-solid fa-arrow-up-right-from-square ms-2"></i>
            </a>
        </div>
    </div>
</header>

<div class="container pb-5">
    <div id="offlineAlert" class="alert alert-danger border-0 shadow-sm d-none text-center rounded-4 mb-4">
        <i class="fa-solid fa-server me-2"></i> <strong>Backend Offline.</strong> Please run <code>python backend.py</code>
    </div>

    <form id="productForm">
        <div class="row g-4">
            
            <div class="col-lg-4">
                
                <div class="glass-card mb-4">
                    <div class="section-header">1. Hero Image</div>
                    <div class="p-4">
                        <div class="upload-zone" onclick="document.getElementById('mainInput').click()">
                            <i class="fa-solid fa-star upload-icon"></i>
                            <div class="upload-text">MAIN THUMBNAIL</div>
                            <small class="text-muted d-block mt-1" style="font-size:0.7rem">Required (1 Image)</small>
                        </div>
                        <input type="file" id="mainInput" accept="image/*" class="d-none">
                        <div id="mainPreview" class="mt-3"></div>
                    </div>
                </div>

                <div class="glass-card mb-4">
                    <div class="section-header">2. Gallery & Videos</div>
                    <div class="p-4">
                        <div class="upload-zone" onclick="document.getElementById('galleryInput').click()">
                            <i class="fa-solid fa-layer-group upload-icon"></i>
                            <div class="upload-text">ADD ANGLES</div>
                            <small class="text-muted d-block mt-1" style="font-size:0.7rem">Multiple Images / Videos</small>
                        </div>
                        <input type="file" id="galleryInput" accept="image/*,video/*" multiple class="d-none">
                        <div class="media-grid" id="galleryPreview"></div>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="section-header">3. Inventory</div>
                    <div class="p-4">
                        <div class="stock-switch" id="stockSwitch">
                            <div class="stock-option active" onclick="setStock('in_stock', this)">IN STOCK</div>
                            <div class="stock-option" onclick="setStock('out_of_stock', this)">SOLD OUT</div>
                        </div>
                        <input type="hidden" id="pStock" value="in_stock">
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="glass-card h-100">
                    <div class="section-header d-flex justify-content-between align-items-center">
                        <span>4. Product Details</span>
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-muted" style="font-size: 0.75rem;">ID:</span>
                            <input type="text" id="pId" class="form-control form-control-sm text-center fw-bold border-0 bg-light" style="width: 80px;" readonly>
                            <button type="button" onclick="fetchNextId()" class="btn btn-sm btn-light rounded-circle"><i class="fa-solid fa-rotate"></i></button>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="form-floating">
                                    <input type="text" class="form-control fw-bold" id="pName" placeholder="Name" required>
                                    <label>Product Title</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="pCategory" onchange="toggleCustom(this, 'customCat')">
                                        <option value="Silk">Silk Saree</option>
                                        <option value="Cotton">Cotton Saree</option>
                                        <option value="Banarasi">Banarasi</option>
                                        <option value="Mysore Silk">Mysore Silk</option>
                                        <option value="Other">Other...</option>
                                    </select>
                                    <label>Category</label>
                                </div>
                                <input type="text" class="form-control mt-2 d-none" id="customCat" placeholder="Enter Category Name">
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="pFabric" onchange="toggleCustom(this, 'customFab')">
                                        <option value="Pure Silk">Pure Silk</option>
                                        <option value="Cotton Mix">Cotton Mix</option>
                                        <option value="Georgette">Georgette</option>
                                        <option value="Art Silk">Art Silk</option>
                                        <option value="Other">Other...</option>
                                    </select>
                                    <label>Fabric Type</label>
                                </div>
                                <input type="text" class="form-control mt-2 d-none" id="customFab" placeholder="Enter Fabric Name">
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="pColor" placeholder="Color">
                                    <label>Color</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select text-warning fw-bold" id="pStars">
                                        <option value="5">★★★★★ (5 Stars)</option>
                                        <option value="4">★★★★☆ (4 Stars)</option>
                                        <option value="3">★★★☆☆ (3 Stars)</option>
                                    </select>
                                    <label class="text-muted">Quality Rating</label>
                                </div>
                            </div>

                            <div class="col-12"><hr class="text-muted opacity-25 my-2"></div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="pPrice" placeholder="Price" required>
                                    <label>Original MRP (₹)</label>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control border-danger text-danger fw-bold" id="pDiscPrice" placeholder="Disc">
                                    <label class="text-danger">Selling Price (₹)</label>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="pDesc" style="height: 120px" placeholder="Desc"></textarea>
                                    <label>Product Description</label>
                                </div>
                            </div>
                            
                            <div class="col-12 mt-4">
                                <button type="submit" class="btn-save w-100" id="submitBtn">
                                    <i class="fa-solid fa-cloud-arrow-up me-2"></i> PUBLISH PRODUCT
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    const API_URL = "http://localhost:8000";
    let mainImageObj = null;
    let galleryImages = [];
    let isIdFetched = false;

    // --- UTILS ---
    function toggleCustom(sel, id) { document.getElementById(id).classList.toggle('d-none', sel.value !== 'Other'); }
    
    function setStock(val, el) {
        document.getElementById('pStock').value = val;
        document.querySelectorAll('.stock-option').forEach(opt => opt.classList.remove('active'));
        el.classList.add('active');
    }

    // --- ID FETCH ---
    async function fetchNextId() {
        try {
            const res = await fetch(API_URL + '/api/get-next-id');
            if(res.ok) {
                const data = await res.json();
                document.getElementById('pId').value = data.next_id;
                isIdFetched = true;
            }
        } catch(e){}
    }

    // --- CONNECTION CHECKER ---
    setInterval(async () => {
        const dot = document.getElementById('statusDot');
        const txt = document.getElementById('statusText');
        try {
            await fetch(API_URL + '/');
            dot.className = "status-dot online";
            txt.innerText = "ONLINE";
            document.getElementById('offlineAlert').classList.add('d-none');
            document.getElementById('submitBtn').disabled = false;
            if(!isIdFetched) fetchNextId();
        } catch (e) {
            dot.className = "status-dot offline";
            txt.innerText = "OFFLINE";
            document.getElementById('offlineAlert').classList.remove('d-none');
            document.getElementById('submitBtn').disabled = true;
        }
    }, 2000);

    // --- MAIN IMAGE ---
    document.getElementById('mainInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            const b64 = evt.target.result.split(',')[1];
            mainImageObj = { type: 'image', base64: b64, rotation: 0 };
            document.getElementById('mainPreview').innerHTML = `
                <div class="media-item w-100">
                    <img src="${evt.target.result}" id="main-img-prev">
                    <button class="btn-rotate" type="button" onclick="rotateMain()"><i class="fa-solid fa-rotate-right"></i></button>
                </div>`;
        };
        reader.readAsDataURL(file);
    });

    function rotateMain() {
        if(!mainImageObj) return;
        mainImageObj.rotation = (mainImageObj.rotation + 90) % 360;
        document.getElementById('main-img-prev').style.transform = `rotate(${mainImageObj.rotation}deg)`;
    }

    // --- GALLERY ---
    document.getElementById('galleryInput').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        const container = document.getElementById('galleryPreview');
        container.innerHTML = ''; galleryImages = [];

        files.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (evt) => {
                const b64 = evt.target.result.split(',')[1];
                const isVideo = file.type.startsWith('video');
                galleryImages.push({ type: isVideo?'video':'image', base64: b64, rotation: 0 });
                
                const el = document.createElement('div');
                el.className = 'media-item';
                if(isVideo) {
                    el.innerHTML = `<video src="${evt.target.result}"></video><i class="fa-solid fa-video position-absolute top-0 end-0 m-2 text-white"></i>`;
                } else {
                    el.innerHTML = `<img src="${evt.target.result}" id="gal-${index}"><button class="btn-rotate" type="button" onclick="rotGal(${index})"><i class="fa-solid fa-rotate-right"></i></button>`;
                }
                container.appendChild(el);
            };
            reader.readAsDataURL(file);
        });
    });

    function rotGal(idx) {
        if(!galleryImages[idx]) return;
        galleryImages[idx].rotation = (galleryImages[idx].rotation + 90) % 360;
        document.getElementById(`gal-${idx}`).style.transform = `rotate(${galleryImages[idx].rotation}deg)`;
    }

    // --- SUBMIT ---
    document.getElementById('productForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerHTML = "<i class='fa-solid fa-spinner fa-spin me-2'></i> PROCESSING...";
        btn.disabled = true;

        try {
            if(!mainImageObj) throw new Error("Main Image is required.");
            
            let cat = document.getElementById('pCategory').value;
            if(cat === 'Other') cat = document.getElementById('customCat').value;
            let fab = document.getElementById('pFabric').value;
            if(fab === 'Other') fab = document.getElementById('customFab').value;

            const payload = {
                id: document.getElementById('pId').value,
                name: document.getElementById('pName').value,
                stock: document.getElementById('pStock').value,
                category: cat,
                fabric: fab,
                color: document.getElementById('pColor').value,
                stars: document.getElementById('pStars').value,
                price: document.getElementById('pPrice').value,
                discount_price: document.getElementById('pDiscPrice').value,
                desc: document.getElementById('pDesc').value,
                mainImage: mainImageObj,
                mediaGallery: galleryImages
            };

            const res = await fetch(API_URL + '/api/add-product', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if(!res.ok) throw new Error("Upload Failed.");
            
            alert("Success! Product is live.");
            location.reload();

        } catch (err) {
            alert(err.message);
            btn.innerHTML = "TRY AGAIN";
            btn.disabled = false;
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>